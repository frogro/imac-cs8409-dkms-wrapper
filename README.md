# cs8409-dkms-wrapper

**DKMS package name:** `cs8409-dkms`  
**Kernel module built/installed:** `snd-hda-codec-cs8409` (Cirrus Logic codec for Apple machines like iMac 2019)

This repository is a clean wrapper to build and install the Cirrus CS8409 HDA codec as an out‑of‑tree DKMS module.
The GitHub repo is named **cs8409-dkms-wrapper**, while the DKMS package that gets registered on your system is **cs8409-dkms**.
That keeps your local DKMS namespace short and conventional, while the repo name makes the intent clear.

> ⚠️ This project intentionally focuses **only on the DKMS driver**. It does *not* touch your audio stack (ALSA/PipeWire),
> does not add resume hooks, and does not change boot params. Those topics can be handled separately once the module works.

---

## 1) Requirements

On Debian/Ubuntu (recommended):

```bash
sudo apt-get update
sudo apt-get install -y dkms build-essential "linux-headers-$(uname -r)"
```

On Fedora:

```bash
sudo dnf install -y dkms kernel-devel "kernel-devel-$(uname -r)" @development-tools
```

On Arch:

```bash
sudo pacman -Sy --noconfirm dkms base-devel linux-headers
```

---

## 2) Quick install

From the repo root:

```bash
sudo ./install.sh
```

What this does:

- Stages the sources into **/usr/src/cs8409-dkms-<VERSION>**
- Runs `dkms add`, `dkms build`, `dkms install`
- Leaves you with **snd_hda_codec_cs8409.ko** under `/lib/modules/<kernel>/updates/dkms` (or the distro’s standard DKMS path)

Load the module:

```bash
sudo modprobe snd_hda_codec_cs8409
dmesg | grep -i cs8409
aplay -l
```

To make sure it comes back after boot, DKMS autoinstall is enabled in `dkms.conf` and your initramfs will be regenerated by the package manager when needed.

---

## 3) Uninstall

```bash
sudo ./uninstall.sh
```

This unloads the module (if loaded), removes the DKMS build/install, and deletes `/usr/src/cs8409-dkms-<VERSION>`.

---

## 4) Layout

```
cs8409-dkms-wrapper/
├─ dkms.conf
├─ VERSION                 # currently: 2025.09.04-1
├─ install.sh              # convenience wrapper → scripts/install.sh
├─ uninstall.sh            # convenience wrapper → scripts/uninstall.sh
├─ module/
│  ├─ Kbuild               # obj-m based build (out-of-tree)
│  └─ src/                 # upstream sources (incl. patch_cirrus/patch_cs8409.c)
└─ scripts/
   ├─ install.sh           # DKMS-only installer
   └─ uninstall.sh         # DKMS-only uninstaller
```

---

## 5) Notes & troubleshooting

- If `dkms build` fails, make sure your **running kernel** has its **headers** installed and matches `uname -r`.
- Some distros place the resulting `.ko` under `/lib/modules/<kernel>/extra` instead of `updates/dkms` – both are fine.
- The Kbuild here compiles `patch_cirrus/patch_cs8409.c` along with `hda_codec.c` and `hda_generic.c`, producing the module `snd-hda-codec-cs8409.ko`.
- This repo does **not** change mixer defaults, power management, or resume behavior. If you need help there, open an issue with your logs.

---

## 6) License

Upstream sources are under their respective kernel licenses. The wrapper (scripts/Kbuild/dkms.conf) is provided under MIT.
